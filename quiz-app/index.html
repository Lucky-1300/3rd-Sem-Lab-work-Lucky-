<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Interactive Quiz — Vanilla JS + Fetch API + ES6+</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#7c3aed; --muted:#94a3b8; --success:#16a34a; --danger:#ef4444;
      --radius:14px; --glass: rgba(255,255,255,0.04);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#071025 0%, #091426 100%); color:#e6eef8; display:flex; align-items:center; justify-content:center; padding:32px;
    }

    .app{
      width:min(1000px,96vw); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:18px; padding:20px; box-shadow:0 10px 30px rgba(2,6,23,0.6);
      display:grid; grid-template-columns:360px 1fr; gap:20px; align-items:start;
    }

    /* Sidebar */
    .panel{background:var(--card); border-radius:12px; padding:18px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);}
    h1{font-size:20px;margin:0 0 8px}
    p.lead{color:var(--muted); margin:0 0 14px}

    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    select,input[type=number],.range{width:100%; padding:10px; background:var(--glass); border:1px solid rgba(255,255,255,0.03); border-radius:8px; color:inherit}
    .row{display:flex; gap:10px}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 12px;border-radius:10px;border:none;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--accent), #4f46e5); box-shadow:0 6px 18px rgba(79,70,229,0.18)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}

    .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .meta .chip{background:rgba(255,255,255,0.03); padding:6px 8px;border-radius:8px;font-size:13px;color:var(--muted)}

    /* Quiz area */
    .quiz{padding:18px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .progress{height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent), #06b6d4); width:0%}

    .question-card{margin-top:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:18px;border-radius:12px}
    .q-text{font-size:18px; line-height:1.4}

    .answers{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px; margin-top:14px}
    .answer{padding:12px;border-radius:10px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); cursor:pointer; text-align:left}
    .answer:focus{outline:2px solid rgba(124,58,237,0.25)}
    .answer.correct{border-color:rgba(22,163,74,0.25); box-shadow:0 6px 20px rgba(16,185,129,0.06);}
    .answer.wrong{border-color:rgba(239,68,68,0.18); opacity:0.9}
    .muted{color:var(--muted)}

    .bottom{display:flex;justify-content:space-between;align-items:center;margin-top:14px}

    .timer{font-weight:700}

    .scores{margin-top:16px}
    .scores li{list-style:none;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.02);color:var(--muted); font-size:13px}

    footer{grid-column:1/-1; text-align:center;margin-top:12px;color:var(--muted); font-size:13px}

    /* responsive */
    @media (max-width:880px){.app{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Interactive Quiz">
    <div class="panel" id="controls">
      <h1>Quiz Settings</h1>
      <p class="lead">Pick category, difficulty and how many questions you want. This demo uses Open Trivia DB API (opentdb.com).</p>

      <label for="amount">Number of questions</label>
      <input id="amount" type="number" min="1" max="50" value="10" />

      <label for="category">Category</label>
      <select id="category">
        <option value="">Any Category</option>
        <option value="9">General Knowledge</option>
        <option value="17">Science & Nature</option>
        <option value="18">Computers</option>
        <option value="21">Sports</option>
        <option value="23">History</option>
        <option value="22">Geography</option>
      </select>

      <label for="difficulty">Difficulty</label>
      <select id="difficulty">
        <option value="">Any</option>
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="hard">Hard</option>
      </select>

      <label for="type">Question type</label>
      <select id="type">
        <option value="">Any</option>
        <option value="multiple">Multiple Choice</option>
        <option value="boolean">True / False</option>
      </select>

      <div style="margin-top:12px" class="row">
        <button class="btn btn-primary" id="startBtn">Start Quiz</button>
        <button class="btn btn-ghost" id="resetBtn">Reset Scores</button>
      </div>

      <div class="meta">
        <div class="chip">ES6+ • fetch • async/await</div>
        <div class="chip">No frameworks</div>
        <div class="chip">Accessible</div>
      </div>

      <div class="panel" style="margin-top:12px;">
        <h3 style="margin:0 0 8px">High scores</h3>
        <ol id="scores" class="scores"></ol>
      </div>
    </div>

    <main class="quiz panel" id="quizArea">
      <div class="topbar">
        <div>
          <div class="muted">Progress</div>
          <div class="progress" aria-hidden="true"><i id="progressBar"></i></div>
        </div>
        <div style="text-align:right">
          <div class="muted">Score</div>
          <div id="scoreDisplay">0</div>
        </div>
      </div>

      <div class="question-card" id="questionCard" hidden>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="muted" id="qIndex">Question 1</div>
          <div class="timer" id="timer">-</div>
        </div>
        <div class="q-text" id="questionText">Question text goes here</div>

        <div class="answers" id="answers"></div>

        <div class="bottom">
          <div class="muted" id="feedback"></div>
          <div>
            <button class="btn btn-ghost" id="nextBtn" disabled>Next</button>
          </div>
        </div>
      </div>

      <div id="startCard" style="text-align:center;padding:30px">
        <h2 style="margin:0 0 8px">Ready to test your JavaScript & API skills?</h2>
        <p class="muted">Click <strong>Start Quiz</strong> to fetch questions and begin.</p>
      </div>

    </main>

    <footer>
      Built with vanilla HTML/CSS/JS — API: Open Trivia DB (opentdb.com)
    </footer>
  </div>

  <script type="module">
    // === Utilities ===
    const $ = sel => document.querySelector(sel);
    const qs = sel => Array.from(document.querySelectorAll(sel));

    const elems = {
      startBtn: $('#startBtn'), resetBtn: $('#resetBtn'), amount: $('#amount'), category: $('#category'), difficulty: $('#difficulty'), type: $('#type'),
      scoresList: $('#scores'), questionCard: $('#questionCard'), startCard: $('#startCard'), questionText: $('#questionText'), answers: $('#answers'), qIndex: $('#qIndex'),
      progressBar: $('#progressBar'), scoreDisplay: $('#scoreDisplay'), nextBtn: $('#nextBtn'), feedback: $('#feedback'), timer: $('#timer')
    };

    // decode HTML entities from API
    const decode = (s)=>{ const txt = document.createElement('textarea'); txt.innerHTML = s; return txt.value; };

    // shuffle an array (Fisher-Yates)
    const shuffle = arr => {
      const a = arr.slice(); for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a;
    };

    // local storage helpers for highscores
    const HKEY = 'quiz_highscores_v1';
    const loadHighscores = ()=> JSON.parse(localStorage.getItem(HKEY) || '[]');
    const saveHighscores = (list)=> localStorage.setItem(HKEY, JSON.stringify(list));

    function renderHighscores(){
      const list = loadHighscores(); elems.scoresList.innerHTML = list.slice(0,10).map(s=>`<li><strong>${s.score}</strong> — ${s.amount}q • ${s.difficulty||'any'} • ${new Date(s.when).toLocaleString()}</li>`).join('') || '<li class="muted">No scores yet</li>';
    }

    // fallback sample questions (used if API fails)
    const FALLBACK = [
      {question: 'Which method converts JSON to a JavaScript object?', correct_answer: 'JSON.parse()', incorrect_answers: ['JSON.stringify()', 'Object.fromJSON()', 'JSON.toObject()']},
      {question: 'Which keyword declares a block-scoped variable?', correct_answer: 'let', incorrect_answers:['var','const?','static']},
    ];

    // === Quiz class ===
    class Quiz {
      constructor(questions){
        this.questions = questions; this.index = 0; this.score = 0; this.perQuestionTime = 20; this.timerId = null; this.timeLeft = 0; this.onChange = ()=>{};
      }
      get current(){ return this.questions[this.index]; }
      get total(){ return this.questions.length; }
      start(){ this.index = 0; this.score = 0; this._emit(); }
      selectAnswer(answer){
        if(this._answered) return; // prevent double-clicks
        this._answered = true;
        const correct = answer === this.current.correct_answer;
        if(correct) this.score += 10; // scoring simple: +10 per correct
        clearInterval(this.timerId);
        return correct;
      }
      next(){ this.index++; this._answered = false; this._emit(); }
      _emit(){ this.onChange && this.onChange(this); }
      startTimer(seconds, onTick, onExpire){
        this.timeLeft = seconds; onTick(this.timeLeft);
        clearInterval(this.timerId);
        this.timerId = setInterval(()=>{
          this.timeLeft -= 1; onTick(this.timeLeft);
          if(this.timeLeft <= 0){ clearInterval(this.timerId); onExpire(); }
        },1000);
      }
    }

    // === API fetch ===
    async function fetchQuestions({amount=10, category='', difficulty='', type=''}){
      const params = new URLSearchParams({amount});
      if(category) params.set('category', category);
      if(difficulty) params.set('difficulty', difficulty);
      if(type) params.set('type', type);
      params.set('encode', 'url3986'); // easier to decode reliably
      const url = `https://opentdb.com/api.php?${params.toString()}`;
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error('Network response not ok');
        const data = await res.json();
        if(data.response_code !== 0) throw new Error('API returned no results');
        // decode and normalize
        const items = data.results.map(r=>({
          question: decode(decodeURIComponent(r.question)),
          correct_answer: decode(decodeURIComponent(r.correct_answer)),
          incorrect_answers: r.incorrect_answers.map(a=>decode(decodeURIComponent(a)))
        }));
        return items;
      }catch(err){
        console.error('Fetch error',err);
        // graceful fallback
        return FALLBACK.map(q=>({question:q.question, correct_answer:q.correct_answer, incorrect_answers:q.incorrect_answers}));
      }
    }

    // === UI wiring ===
    let quiz = null;

    function buildAnswersUI(q){
      const choices = q.type === 'boolean' ? ['True','False'] : shuffle([q.correct_answer, ...q.incorrect_answers]);
      elems.answers.innerHTML = '';
      choices.forEach(choice => {
        const btn = document.createElement('button'); btn.className = 'answer'; btn.setAttribute('tabindex',0);
        btn.innerHTML = `<span>${choice}</span>`;
        btn.addEventListener('click', ()=> handleSelect(btn, choice));
        elems.answers.appendChild(btn);
      });
    }

    function updateProgress(){
      const pct = Math.round((quiz.index / quiz.total) * 100);
      elems.progressBar.style.width = pct + '%';
      elems.scoreDisplay.textContent = quiz.score;
      elems.qIndex.textContent = `Question ${Math.min(quiz.index+1, quiz.total)} of ${quiz.total}`;
    }

    function showQuestion(){
      if(quiz.index >= quiz.total){ showResults(); return; }
      const q = quiz.current;
      elems.questionCard.hidden = false; elems.startCard.hidden = true;
      elems.feedback.textContent = '';
      elems.questionText.textContent = q.question;
      buildAnswersUI(q);
      elems.nextBtn.disabled = true;

      // start per-question timer
      quiz.startTimer(20, (sec)=>{ elems.timer.textContent = `${sec}s`; }, ()=>{
        // time expired
        elems.feedback.textContent = 'Time up!';
        revealCorrect(); elems.nextBtn.disabled = false;
      });
      updateProgress();
    }

    function revealCorrect(){
      const correct = quiz.current.correct_answer;
      qs('.answer').forEach(btn=>{
        if(btn.textContent.trim() === correct) btn.classList.add('correct');
      });
    }

    function handleSelect(btn, choice){
      const correct = quiz.selectAnswer(choice);
      // mark buttons
      qs('.answer').forEach(b=>{ b.disabled=true; b.classList.remove('correct','wrong'); });
      if(correct){ btn.classList.add('correct'); elems.feedback.textContent = 'Correct! +10'; }
      else{ btn.classList.add('wrong'); elems.feedback.textContent = `Wrong — correct was: ${quiz.current.correct_answer}`; revealCorrect(); }
      elems.nextBtn.disabled = false;
      updateProgress();
    }

    function showResults(){
      // record highscore
      const item = {score: quiz.score, amount: quiz.total, difficulty: elems.difficulty.value || 'any', when: Date.now()};
      const list = loadHighscores(); list.unshift(item); list.sort((a,b)=>b.score-a.score); saveHighscores(list);
      renderHighscores();

      elems.questionCard.hidden = true; elems.startCard.hidden = false;
      elems.startCard.innerHTML = `<div style="padding:16px"><h2>Quiz finished</h2><p class="muted">Your score: <strong>${quiz.score}</strong> / ${quiz.total*10}</p><p class="muted">High scores updated.</p></div>`;
      elems.progressBar.style.width = '100%';
    }

    // buttons
    elems.nextBtn.addEventListener('click', ()=>{
      quiz.next(); showQuestion();
    });

    elems.resetBtn.addEventListener('click', ()=>{ if(confirm('Clear saved highscores?')){ localStorage.removeItem(HKEY); renderHighscores(); } });

    elems.startBtn.addEventListener('click', async ()=>{
      const opts = {amount: Math.max(1, Number(elems.amount.value || 10)), category: elems.category.value, difficulty: elems.difficulty.value, type: elems.type.value};
      elems.startBtn.disabled = true; elems.startBtn.textContent = 'Fetching...';
      const items = await fetchQuestions(opts);
      // normalize type for boolean questions (API returns 'True'/'False' strings), but store 'type' optional
      const normalized = items.map(it=>({...it, type: (it.incorrect_answers.length===1 && it.incorrect_answers.includes('False')? 'boolean':'multiple')}));
      quiz = new Quiz(normalized);
      quiz.onChange = ()=>{};
      quiz.start(); showQuestion();
      elems.startBtn.disabled = false; elems.startBtn.textContent = 'Start Quiz';
    });

    // initial render
    renderHighscores();

    // keyboard accessibility: Enter on answer triggers click
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && document.activeElement && document.activeElement.classList.contains('answer')){
        document.activeElement.click();
      }
    });

  </script>
</body>
</html>
